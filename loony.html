<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>loony</title>
<link rel="stylesheet" type="text/css" href="nimdoc.out.css">

<script type="text/javascript" src="dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  if (toggleSwitch !== null) {
    toggleSwitch.addEventListener('change', switchTheme, false);
  }

  var currentTheme = localStorage.getItem('theme');
  if (!currentTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    currentTheme = 'dark';
  }
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark' && toggleSwitch !== null) {
      toggleSwitch.checked = true;
    }
  }
}

window.addEventListener('DOMContentLoaded', main);
</script>

</head>
<body>
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">loony</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<li>
  <a class="reference reference-toplevel" href="#6" id="56">Imports</a>
  <ul class="simple simple-toc-section">
    
  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#7" id="57">Types</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#LoonyQueue"
    title="LoonyQueue[T] = ref object
  head: Atomic[TagPtr]       ## Whereby node contains the slots and idx
  tail: Atomic[TagPtr]       ## is the uint16 index of the slot array
  currTail: Atomic[NodePtr]  ## 8 bytes Current NodePtr">LoonyQueue</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#12" id="62">Procs</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">initLoonyQueue
      <li><a class="reference" href="#initLoonyQueue%2CLoonyQueue"
    title="initLoonyQueue(q: LoonyQueue)">initLoonyQueue(q: LoonyQueue)</a></li>
  <li><a class="reference" href="#initLoonyQueue"
    title="initLoonyQueue[T](): LoonyQueue[T]">initLoonyQueue[T](): LoonyQueue[T]</a></li>

  </ul>
  <ul class="simple nested-toc-section">isEmpty
      <li><a class="reference" href="#isEmpty%2CLoonyQueue"
    title="isEmpty(queue: LoonyQueue): bool">isEmpty(queue: LoonyQueue): bool</a></li>

  </ul>
  <ul class="simple nested-toc-section">pop
      <li><a class="reference" href="#pop%2CLoonyQueue%5BT%5D"
    title="pop[T](queue: LoonyQueue[T]): T">pop[T](queue: LoonyQueue[T]): T</a></li>

  </ul>
  <ul class="simple nested-toc-section">push
      <li><a class="reference" href="#push%2CLoonyQueue%5BT%5D%2CT"
    title="push[T](queue: LoonyQueue[T]; el: T)">push[T](queue: LoonyQueue[T]; el: T)</a></li>

  </ul>
  <ul class="simple nested-toc-section">toStrTuple
      <li><a class="reference" href="#toStrTuple%2CTagPtr"
    title="toStrTuple(tag: TagPtr): string">toStrTuple(tag: TagPtr): string</a></li>

  </ul>

  </ul>
</li>

</ul>

  </div>
  &nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L1"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L1" class="link-seesrc" target="_blank" >Edit</a>

  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc">TagPtr is an alias for 8 byte uint (pointer). We reserve a portion of the tail to contain the index of the slot to its corresponding node by aligning the node pointers on allocation. Since the index value is stored in the same memory word as its associated node pointer, the FAA operations could potentially affect both values if too many increments were to occur. This is accounted for in the algorithm and with space for overflow in the alignment. See Section 5.2 for the paper to see why an overflow would prove impossible except under extraordinarily large number of thread contention.<p>Both enqueue and dequeue enter FAST PATH operations 99% of the time, however in cases we enter the SLOW PATH operations represented in both enq and deq by advTail and advHead respectively.</p>
<p>This path requires the threads to first help updating the linked list struct before retrying and entering the fast path in the next attempt.</p>
<p>Fundamentally, both enqueue and dequeue operations attempt to exclusively reserve access to a slot in the array of their associated queue node by automatically incremementing the appropriate index value and retrieving the previous value of the index as well as the current node pointer.</p>
<p>Threads that retrieve an index i &lt; N (length of the slots array) gain <em>exclusive</em> rights to perform either write/consume operation on the corresponding slot.</p>
<p>This guarantees there can only be exactly one of each for any given slot.</p>
<p>Where i &lt; N, we use FAST PATH operations. These operations are designed to be as fast as possible while only dealing with memory contention in rare edge cases.</p>
<p>if not i &lt; N, we enter SLOW PATH operations. See AdvTail and AdvHead above.</p>
<p>Fetch And Add (FAA) primitives are used for both incrementing index values as well as performing read(consume) and write operations on reserved slots which drastically improves scalability compared to Compare And Swap (CAS) primitives.</p>
<p>Note that all operations on slots must modify the slots state bits to announce both operations completion (in case of a read) and also makes determining the order in which two operations occured possible.</p>
<p>Consumed slots have been written to and then read. If a concurrent deque operation outpaces the corresponding enqueue operation then both operations have to abandon and try again. Once all slots in the node have been consumed or abandoned, the node is considered drained and unlinked from the list. Node can be reclaimed and de-allocated.</p>
<p>Queue manages an enqueue index and a dequeue index. Each are modified by fetchAndAdd; gives thread reserves previous index for itself which may be used to address a slot in the respective nodes array.</p>
<p>ANCHOR both node pointers are tagged with their assoc index value -&gt; they store both address to respective node as well as the current index value in the same memory word.</p>
<p>Requires a sufficient number of available bits that are not used to present the nodes addresses themselves.</p>
</p>
  <div class="section" id="6">
<h1><a class="toc-backref" href="#6">Imports</a></h1>
<dl class="item">
<a class="reference external" href="loony/spec.html">loony/spec</a>, <a class="reference external" href="loony/node.html">loony/node</a>
</dl></div>
<div class="section" id="7">
<h1><a class="toc-backref" href="#7">Types</a></h1>
<dl class="item">
<div id="LoonyQueue">
<dt><pre><a href="loony.html#LoonyQueue"><span class="Identifier">LoonyQueue</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
  <span class="Identifier">head</span><span class="Other">:</span> <span class="Identifier">Atomic</span><span class="Other">[</span><a href="loony/spec.html#TagPtr"><span class="Identifier">TagPtr</span></a><span class="Other">]</span>       <span class="Comment">## Whereby node contains the slots and idx</span>
  <span class="Identifier">tail</span><span class="Other">:</span> <span class="Identifier">Atomic</span><span class="Other">[</span><a href="loony/spec.html#TagPtr"><span class="Identifier">TagPtr</span></a><span class="Other">]</span>       <span class="Comment">## is the uint16 index of the slot array</span>
  <span class="Identifier">currTail</span><span class="Other">:</span> <span class="Identifier">Atomic</span><span class="Other">[</span><a href="loony/spec.html#NodePtr"><span class="Identifier">NodePtr</span></a><span class="Other">]</span>  <span class="Comment">## 8 bytes Current NodePtr</span>
  </pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L16"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L16" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>

</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#12">Procs</a></h1>
<dl class="item">
<div id="initLoonyQueue,LoonyQueue">
<dt><pre><span class="Keyword">proc</span> <a href="#initLoonyQueue%2CLoonyQueue"><span class="Identifier">initLoonyQueue</span></a><span class="Other">(</span><span class="Identifier">q</span><span class="Other">:</span> <a href="loony.html#LoonyQueue"><span class="Identifier">LoonyQueue</span></a><span class="Other">)</span></pre></dt>
<dd>

Initialize an existing LoonyQueue.
&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L273"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L273" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="initLoonyQueue">
<dt><pre><span class="Keyword">proc</span> <a href="#initLoonyQueue"><span class="Identifier">initLoonyQueue</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Other">)</span><span class="Other">:</span> <a href="loony.html#LoonyQueue"><span class="Identifier">LoonyQueue</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span></pre></dt>
<dd>

Return an initialized LoonyQueue.
&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L288"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L288" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="isEmpty,LoonyQueue">
<dt><pre><span class="Keyword">proc</span> <a href="#isEmpty%2CLoonyQueue"><span class="Identifier">isEmpty</span></a><span class="Other">(</span><span class="Identifier">queue</span><span class="Other">:</span> <a href="loony.html#LoonyQueue"><span class="Identifier">LoonyQueue</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span></pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L221"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L221" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="pop,LoonyQueue[T]">
<dt><pre><span class="Keyword">proc</span> <a href="#pop%2CLoonyQueue%5BT%5D"><span class="Identifier">pop</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">queue</span><span class="Other">:</span> <a href="loony.html#LoonyQueue"><span class="Identifier">LoonyQueue</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">T</span></pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L225"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L225" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="push,LoonyQueue[T],T">
<dt><pre><span class="Keyword">proc</span> <a href="#push%2CLoonyQueue%5BT%5D%2CT"><span class="Identifier">push</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">queue</span><span class="Other">:</span> <a href="loony.html#LoonyQueue"><span class="Identifier">LoonyQueue</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">el</span><span class="Other">:</span> <span class="Identifier">T</span><span class="Other">)</span></pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L173"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L173" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="toStrTuple,TagPtr">
<dt><pre><span class="Keyword">proc</span> <a href="#toStrTuple%2CTagPtr"><span class="Identifier">toStrTuple</span></a><span class="Other">(</span><span class="Identifier">tag</span><span class="Other">:</span> <a href="loony/spec.html#TagPtr"><span class="Identifier">TagPtr</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">string</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/loony/tree/49acf624a022baf4007b42f19e17cd8a04e25952/loony.nim#L44"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/loony/edit/main/loony.nim#L44" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2021-09-23 16:28:00 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
